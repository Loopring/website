<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>150,000 RICE at your grasp</title>
		<link rel="stylesheet" type="text/css" href="../style.css" />
		<link rel="stylesheet" type="text/css" href="styleEn.css" />
	</head>
	<body>
		<div class="wrapper">
			<div class="top">
				<div class="topContent">
					<img
						class="imgSlogan imgSloganEn"
						src="../images/logoEn.png"
					/>
					<!-- <span class="textSloganEn">Luckydraw through Red Packet</span> -->
					<img
						class="imgSlogan"
						style="margin-top: default;"
						src="../images/riceEn.png"
					/>
					<div class="triangle"></div>
					<div class="priceWrapper priceWrapperEn">
						<div>
							<div>
								<span>Average Share(RICE)</span>
								<span>Particiating Users / Users Limit</span>
							</div>
							<div>
								<span id="rate">***</span>
								<span
									><span id="currentPrice">***</span>
									<span style="font-weight: 300;">/</span>
									888</span
								>
							</div>
						</div>
						<div>
							<a
								class="rules"
								href="https://medium.com/loopring-protocol/loopring-announces-a-collaboration-with-daosquare-and-an-exclusive-lucky-draw-for-loopring-smart-b0a2e62ddc7d"
								>Activity Rules ></a
							>
						</div>
					</div>
				</div>
			</div>
			<div class="bottom">
				<div id="lotteryTitle">· Eligible addresses ·</div>
				<!-- <div class="updateTime">
					Data update: update after 0:00 am (UTC) the next day
				</div> -->
				<div class="userListWrapper">
					<input
						id="inputSearch"
						class="inputSearch"
						type="text"
						placeholder="Input your account ID or address"
					/>
					<div class="listContentWrapper">
						<div class="listTitleLine">
							<span>Account ID</span>
							<span>Address</span>
						</div>
						<div id="userList" class="userList"></div>
					</div>
				</div>
				<div class="btnLine">
					<span id="leftTimeWrapper"
						>Time Ends:<span id="leftTime"></span
					></span>
					<!-- <button id="btnAttend" class="btnAttend">
						<a
							class="rules"
							style="color: white; font-size: 14px;"
							href="https://exchange.loopring.io/"
							>Participate</a
						>
					</button> -->
				</div>
			</div>
		</div>
		<script type="text/javascript" src="../js/jquery.min.js"></script>
		<script type="text/javascript" src="../js/jquery.csv.min.js"></script>
		<script type="text/javascript" src="../js/moment.min.js"></script>
		<script>
			$(document).ready(function() {
				let jsonData = []
				let isSearch = false
				const startTime = moment('2021/05/21 20:00:00').valueOf()
				const endTime = moment('2021/05/22 20:00:00').valueOf()
				getData() && setInterval(getData, 10 * 1000)

				// get countdown
				;(function getLefttime() {
					const targetTime = new Date('2021/05/22 20:00:00')
					const currentTime = new Date()
					const diff = targetTime - currentTime
					if (diff < 0) {
						// $('#lotteryTitle').html('· 中奖名单 ·')
						$('#leftTimeWrapper').html(
							`<span class="timeNumber" style="color: black">活动已结束</span>`
						)
						// $('#btnAttend').html(
						// 	`
						// 	<a
						// 		class="rules"
						// 		style="color: white; font-size: 14px;"
						// 		href="https://blogs.loopring.org/dpr-lottery-mechanism-cn/"
						// 	>抽奖规则</a>`
						// )
						// $('#btnAttend').css({
						// 	'background-color': '#bec8c8',
						// })
					} else {
						setInterval(() => {
							const diff = new Date('2021/05/22 20:00:00') - new Date()
							const leftDays = Math.floor(
								diff / (24 * 3600 * 1000)
							)
							const msHours = diff % (24 * 3600 * 1000)
							const leftHours = Math.floor(
								msHours / (3600 * 1000)
							) + (leftDays ? 24 : 0)
							const msMinutes = msHours % (3600 * 1000)
							const leftMinutes = Math.floor(
								msMinutes / (60 * 1000)
							)
							const msSeconds = msMinutes % (60 * 1000)
							const leftSeconds = Math.floor(msSeconds / 1000)
							$('#leftTime').html(
								`<span class="timeNumber">${leftHours}</span>H<span class="timeNumber">${leftMinutes}</span>M<span class="timeNumber">${leftSeconds}</span>S`
							)
						}, 1000)
					}
				})()

				function getData(){
					if (isSearch) return
					$.ajax({
						// UAT -- url: 'http://uat2.loopring.io/api/v3/user/daoSquareAccounts',
						url: `https://api3.loopring.io/api/v3/user/daoSquareAccounts?startTime=${startTime}&endTime=${endTime}`,
						success: function(res) {
							const addressList = Object.keys(res)
							const accountIdList = Object.values(res)
							const formattedData = accountIdList.map((accountId ,index) => ({
								accountId,
								address: addressList[index]
							}))

							if (formattedData.length) {
								const limitedData = formattedData.slice(0, 888)
								jsonData = limitedData
								setUserList(limitedData)
								$('#currentPrice').html(formattedData.length)
								$('#rate').html(parseInt(150000 / (limitedData === 888 ? 888 : limitedData.length)))
							}
						}
					})
					return true
				}

				$('#inputSearch').on('paste', (e) => {
					let pasteContent = ''
					if (window.clipboardData && window.clipboardData.getData) {
						pasteContent = window.clipboardData.getData('Text');
					} else {
						pasteContent = e.originalEvent.clipboardData.getData('Text');
					}
					handleInputOrPaste(String(pasteContent))
				}).on('input', (e) => {
					handleInputOrPaste(e.target.value)
				})

				function handleInputOrPaste (content) {
					isSearch = true
					const keyword = content
					const formattedKeyword = keyword.toLowerCase()
					const isInvolved = jsonData.find(
						(o) =>
						String(o.accountId) === formattedKeyword ||
						o.address === formattedKeyword
						)
					if (!!jsonData.length && isInvolved) {
						const head = isInvolved.address.substring(0, 8)
						const tail = isInvolved.address.substring(
							isInvolved.address.length - 6,
							isInvolved.address.length
							)
						const address = `${head}...${tail}`
						$('#userList').html(
							`
                            <div class="singleUser">
                                <span class="userId">${isInvolved.accountId}</span>
                                <span class="userAddress">${address}</span>
                            </div>
                        `
						)
						return
					} 
					if (!keyword) {
						setUserList(jsonData)
						isSearch = false
						return
					}
					$('#userList').html('')
				}

				function setUserList(data) {
					let listContent = ''
					data.forEach(o => {
						const head = o.address.substring(0, 8)
						const tail = o.address.substring(
							o.address.length - 6,
							o.address.length
						)
						const address = `${head}...${tail}`
						listContent += `
                            <div class="singleUser" style="margin-bottom: 10px;">
                                <span class="userId">${o.accountId}</span>
                                <span class="userAddress">${address}</span>
                            </div>
                        `
					})
					$('#userList').html(listContent)
				}
				// const csvFile = 'DPR.csv'
				// const csvFile = 'winners.csv'
				// $.ajax({
				// 	url: csvFile,
				// 	dataType: 'text',
				// 	success: function(data) {
				// 		jsonData = $.csv.toArrays(data).map((o) => ({
				// 			id: o[0],
				// 			address: o[1],
				// 		}))
				// 		setUserList(jsonData)
				// 	},
				// })
			})
		</script>
	</body>
</html>
